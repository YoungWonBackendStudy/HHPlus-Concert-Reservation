# 동시성 처리

## 1. 락: Pros & Cons
| | 특징                                                                                                 | Pros                           | Cons                                                 |
|---|----------------------------------------------------------------------------------------------------|--------------------------------|------------------------------------------------------|
|낙관락| **Update할 때 Version 확인**<br> 조회 시점과 Update 시점의 Version이 다르면 Update 실패                              | 다른 Transaction에 영향을 주지 않음      | 트래픽이 몰릴 때 성능이 크게 하락<br> (Retry 정책을 이용할 시)            |
|비관락| **Select할 때 Lock 설정. Transaction이 끝나면 Lock 해제**<br> 다른 Transaction이 Lock을 걸려면 이전 Lock이 해제될 때 까지 대기 | 전부 DB에서 처리하므로 높은 성능            | Transaction이 대기하므로, DB에 부하 증가
|분산락| **DB외에 Lock을 위한 Resource를 추가**<br> Redis/Kafka 등에서 Lock을 따로 관리                                     | DB 부하 감소 <br> Lock을 자유롭게 이용 가능 | 1. Lock 관리를 위한 추가 Resource 필요 <br> 2. 코드 복잡도 증가 <br> |

## 2. UseCases
### 대기열
  - 토큰 발급
  - ~~토큰 검증 (Interceptor)~~ > 동시성 이슈 X
  - 토큰 만료/활성화 (Scheduler)
### 콘서트
  - ~~콘서트/스케줄/좌석 조회~~ > 동시성 이슈 X
  - 좌석 예약 만료 (Scheduler)
### 예약
  - 콘서트 좌석 예약
### 결제
  - 결제
### 사용자
  - ~~자산 조회~~ > 동시성 이슈 X
  - 자산 충전

## 3. UseCase 분석
### 토큰 발급
 - Transaction 범위 : 최소 범위 (JPA)
 - 동시성 문제: User 한 명에 여러개의 대기열 토큰 발급 
 - 해결 방법: Unique Constraint (userId, status)
 - 이유: 
   - LOCK 구현 없이 해결 가능

### 토큰 만료/활성화
 - Transaction 범위 : 최소 범위 (JPA)
 - 동시성 문제: 동시에 조회 -> Update로 인해 Lost Update 발생
 - 동시성 해결: 조치 X
 - 이유: 
   - 비지니스 로직 상 Lost Update가 발생해도 문제가 없음
   - 모두 같은 결과를 예상하기 때문에

### 좌석 예약 만료/활성화
- Transaction 범위 : 최소 범위 (JPA)
- 동시성 문제: 동시에 조회 -> Update로 인해 Lost Update 발생
- 동시성 해결: 조치 X
- 이유:
  - 비지니스 로직 상 Lost Update가 발생해도 문제가 없음
  - 모두 같은 결과를 예상하기 때문에

### 콘서트 좌석 예약
- Transaction 범위: Service 함수
- 동시성 문제: 하나의 좌석에 대한 여러개의 예약 발생
- 동시성 해결: 분산락
- 이유:
  - 동시성 이슈가 발생했을 때 대기할 필요 없음
  - 분산락: 락 획득 시도 후 실패시 DB Connection 없이 종료 가능

### 결제
- Transaction 범위: Facade 함수
- 동시성 문제: 금액 차감에서 Lost Update 발생 & 하나의 예약에 대한 다수의 결제 발생
- 동시성 해결: 비관적 락
- 이유:
  - 낙관락은 성능 이슈가 발생할 수 있음
  - DB에 부하를 발생시킬 정도의 동시성 이슈가 예상되지 않음

### 잔액 충전
- Transaction 범위: Service 함수
- 동시성 문제: 잔액 충전 시 Lost Update 발생
- 동시성 해결: 비관적 락
- 이유:
  - 낙관락은 성능 이슈가 발생할 수 있음
  - DB에 부하를 발생시킬 정도의 동시성 이슈가 예상되지 않음
  - History 를 이용한 해결 방법: 조회 성능이 매우 떨어질 수 있음